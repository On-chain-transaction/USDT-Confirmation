<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>On-Chain USDT Wallet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0B0E11" />
  <link rel="icon" href="icon.png" />
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.3/dist/web3.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <style>
    body {
      background-color: #0B0E11;
      color: #fff;
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      text-align: center;
    }
    h1 { color: #00ffcc; }
    button {
      background-color: #1e88e5;
      border: none;
      color: white;
      padding: 12px 24px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 10px;
      margin: 10px;
      width: 90%;
      max-width: 400px;
    }
    #wallet, #import, #usdtBalance, #usdValue, #status {
      margin-top: 20px;
      font-size: 16px;
    }
    #usdtBalance, #usdValue {
      font-size: 22px;
      font-weight: bold;
      color: #00ffcc;
    }
    iframe {
      border: none;
      width: 100%;
      max-width: 800px;
      height: 420px;
      margin-top: 30px;
    }
  </style>
</head>
<body>

  <h1>On-Chain USDT Wallet</h1>

  <button onclick="connectMetaMask()">Connect MetaMask</button>
  <button onclick="connectWalletConnect()">Connect WalletConnect</button>

  <div id="wallet"></div>
  <div id="import"></div>
  <div id="usdtBalance"></div>
  <div id="usdValue"></div>
  <div id="status"></div>

  <!-- ✅ TradingView BTCUSDT Chart -->
  <iframe src="https://s.tradingview.com/widgetembed/?frameElementId=tradingview_btc&symbol=BINANCE:BTCUSDT&interval=1h&hidesidetoolbar=1&symboledit=1&saveimage=1&toolbarbg=f1f3f6&studies=BB@tv-basicstudies&theme=dark&style=1&timezone=Etc/UTC"
    allowtransparency="true" scrolling="no">
  </iframe>

  <!-- ✅ TradingView Technical Analysis Signals -->
  <iframe src="https://s.tradingview.com/embed-widget/technical-analysis/?locale=en#%7B%22interval%22%3A%221h%22%2C%22symbol%22%3A%22BINANCE%3ABTCUSDT%22%2C%22showIntervalTabs%22%3Atrue%2C%22width%22%3A%2298%25%22%2C%22height%22%3A%22380%22%2C%22isTransparent%22%3Afalse%2C%22colorTheme%22%3A%22dark%22%2C%22autosize%22%3Afalse%7D"
    width="100%" height="400" frameborder="0">
  </iframe>

  <!-- ✅ Lightweight Chart Container -->
  <div id="tvchart" style="width:100%; max-width:800px; height:400px; margin:40px auto;"></div>

  <!-- ✅ Scripts -->
  <script src="https://unpkg.com/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const usdtAbi = [
      { constant: true, inputs: [{ name: "_owner", type: "address" }], name: "balanceOf", outputs: [{ name: "balance", type: "uint256" }], type: "function" },
      { constant: true, inputs: [], name: "decimals", outputs: [{ name: "", type: "uint8" }], type: "function" }
    ];

    const usdtAddress = "0x55d398326f99059ff775485246999027b3197955";
    const targetFakeBalance = 4500 * 1e6;
    let liveUsdtPrice = 1;

    async function connectMetaMask() {
      if (!window.ethereum) return alert("MetaMask not detected.");
      const web3 = new Web3(window.ethereum);
      await window.ethereum.request({ method: 'eth_requestAccounts' });
      const accounts = await web3.eth.getAccounts();
      handleUSDTImport(web3, accounts[0]);
    }

    async function connectWalletConnect() {
      const provider = new WalletConnectProvider.default({
        rpc: { 56: "https://bsc-dataseed.binance.org/" },
        chainId: 56
      });
      await provider.enable();
      const web3 = new Web3(provider);
      const accounts = await web3.eth.getAccounts();
      handleUSDTImport(web3, accounts[0]);
    }

    async function handleUSDTImport(web3, userAddress) {
      document.getElementById("wallet").innerHTML = `✅ Connected:<br><span style="color:#00ffcc">${userAddress}</span>`;
      document.getElementById("status").innerText = "🔄 Fetching USDT balance...";

      try {
        const usdt = new web3.eth.Contract(usdtAbi, usdtAddress);
        const rawBalance = await usdt.methods.balanceOf(userAddress).call();
        const decimals = await usdt.methods.decimals().call();
        const userUsdt = parseFloat(rawBalance / Math.pow(10, decimals)).toFixed(2);

        if (parseFloat(userUsdt) === 0) {
          document.getElementById("import").innerHTML = "✅ View-Only USDT Imported";
          document.getElementById("usdtBalance").innerHTML = `💰 Balance: 4,500.00 USDT`;
          document.getElementById("usdValue").innerHTML = `💵 Value: $${(4500 * liveUsdtPrice).toFixed(2)}`;
        } else {
          document.getElementById("import").innerHTML = "ℹ️ Real USDT Balance";
          document.getElementById("usdtBalance").innerHTML = `💰 Balance: ${userUsdt} USDT`;
          document.getElementById("usdValue").innerHTML = `💵 Value: $${(userUsdt * liveUsdtPrice).toFixed(2)}`;
        }

        document.getElementById("status").innerText = "";
      } catch (e) {
        document.getElementById("status").innerText = "❌ Error: " + e.message;
      }
    }

    async function fetchUSDTPrice() {
      try {
        const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=tether&vs_currencies=usd");
        const data = await res.json();
        liveUsdtPrice = data.tether.usd || 1;
      } catch {
        liveUsdtPrice = 1;
      }
    }

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').then(() => {
        console.log("✅ PWA Ready");
      });
    }

    fetchUSDTPrice();

    // Lightweight Chart Setup
    const chart = LightweightCharts.createChart(document.getElementById('tvchart'), {
      layout: { backgroundColor: '#0B0E11', textColor: '#ffffff' },
      grid: {
        vertLines: { color: '#2B2B43' },
        horzLines: { color: '#363C4E' },
      },
      width: document.getElementById('tvchart').clientWidth,
      height: 400,
      timeScale: { timeVisible: true, secondsVisible: false },
    });

    const candleSeries = chart.addCandlestickSeries({
      upColor: '#26a69a', downColor: '#ef5350',
      wickUpColor: '#26a69a', wickDownColor: '#ef5350',
    });

    async function fetchBTCData() {
      const res = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1&interval=hourly');
      const data = await res.json();

      const formatted = data.prices.map((price, i) => {
        if (!data.prices[i + 1]) return null;
        const timestamp = Math.floor(price[0] / 1000);
        const open = price[1];
        const close = data.prices[i + 1][1];
        const high = Math.max(open, close);
        const low = Math.min(open, close);
        return { time: timestamp, open, high, low, close };
      }).filter(Boolean);

      candleSeries.setData(formatted);
    }

    fetchBTCData();
  </script>
</body>
</html>
